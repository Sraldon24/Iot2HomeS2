{% extends "base.html" %}
{% block content %}
<h2>ğŸ“Š Dashboard</h2>

<div class="card">
  <h3>ğŸŒ¡ï¸ Live Sensors (Adafruit IO)</h3>
  <div class="live-grid">
    <div class="sensor-box">
      <span>Temperature:</span>
      <strong id="temp">{{ live_data.get('temperature', 'N/A') }}</strong> Â°C
    </div>
    <div class="sensor-box">
      <span>Humidity:</span>
      <strong id="humidity">{{ live_data.get('humidity', 'N/A') }}</strong> %
    </div>
    <div class="sensor-box">
      <span>Motion:</span>
      <strong id="motion">{{ 'ğŸ”´ YES' if live_data.get('motion') == '1' else 'ğŸŸ¢ No' }}</strong>
    </div>
  </div>
  <button onclick="refreshLive()">ğŸ”„ Refresh</button>
</div>

<div class="card">
  <h3>ğŸ›ï¸ Device Status</h3>
  <table>
    <tr><th>Device</th><th>Status</th></tr>
    <tr><td>LED</td><td>{{ 'ğŸŸ¢ ON' if device_states.get('led_status') == '1' else 'âš« OFF' }}</td></tr>
    <tr><td>Buzzer</td><td>{{ 'ğŸ”Š ON' if device_states.get('buzzer_status') == '1' else 'ğŸ”‡ OFF' }}</td></tr>
    <tr><td>Motor</td><td>{{ 'ğŸŒ€ ON' if device_states.get('motor_status') == '1' else 'â­• OFF' }}</td></tr>
  </table>
</div>

<div class="card">
  <h3>ğŸ“ˆ Recent Environment</h3>
  {% if latest_env %}
  <table>
    <tr><th>Time</th><th>Temp (Â°C)</th><th>Humidity (%)</th></tr>
    {% for row in latest_env %}
    <tr><td>{{ row[0] }}</td><td>{{ "%.1f"|format(row[1]) }}</td><td>{{ "%.1f"|format(row[2]) }}</td></tr>
    {% endfor %}
  </table>
  {% else %}
  <p>No data yet</p>
  {% endif %}
</div>

<div class="card">
  <h3>â˜ï¸ Sync Status</h3>
  <p>Pending: {{ sync_pending.env }} env + {{ sync_pending.motion }} motion</p>
  {% if sync_pending.env > 0 or sync_pending.motion > 0 %}
  <p class="warning">âš ï¸ Syncing...</p>
  {% else %}
  <p class="success">âœ… All synced</p>
  {% endif %}
</div>

<script>
function refreshLive() {
  fetch('/api/live-data')
    .then(r => r.json())
    .then(d => {
      document.getElementById('temp').textContent = d.temperature || 'N/A';
      document.getElementById('humidity').textContent = d.humidity || 'N/A';
      document.getElementById('motion').textContent = d.motion === '1' ? 'ğŸ”´ YES' : 'ğŸŸ¢ No';
    });
}
setInterval(refreshLive, 30000);
</script>
{% endblock %}