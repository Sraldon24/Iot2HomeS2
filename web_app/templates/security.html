<!-- FILE: web_app/templates/security.html (FIXED) -->
{% extends "base.html" %}
{% block content %}

<h2>ğŸš¨ Security System</h2>

<!-- SYSTEM ENABLE/DISABLE -->
<div class="card">
  <h3>ğŸ” System Status</h3>
  <div class="status-box {{ 'enabled' if is_enabled else 'disabled' }}">
    <div style="font-size: 32px;">{{ 'ğŸŸ¢' if is_enabled else 'ğŸ”´' }}</div>
    <div><strong>Security is {{ 'ENABLED' if is_enabled else 'DISABLED' }}</strong></div>
  </div>

  <form method="POST" style="margin-top: 20px; display:flex; gap:10px;">
    <button type="submit" name="toggle_security"
            value="{{ 'disable' if is_enabled else 'enable' }}"
            class="{{ 'btn-disable' if is_enabled else 'btn-enable' }}">
      {{ 'ğŸ”’ Disable Security' if is_enabled else 'ğŸ”“ Enable Security' }}
    </button>
  </form>
</div>


<!-- INTRUSION LOOKUP -->
<div class="card">
  <h3>ğŸ“… Intrusion History Lookup</h3>
  <form method="POST" style="display: flex; gap: 10px; align-items: center;">
    <input type="date" name="date" value="{{ selected_date }}" required>
    <button type="submit" class="btn-enable">Search</button>
  </form>

  <p style="margin-top: 15px;">
    ğŸ“Š <strong>{{ selected_date }}:</strong> 
    {% if total_intrusions > 0 %}
      <span style="color: #ef4444;">{{ total_intrusions }} intrusion(s) detected</span>
    {% else %}
      <span style="color: #22c55e;">No intrusions</span>
    {% endif %}
  </p>
</div>


<!-- INTRUSION LOG TABLE -->
<div class="card">
  <h3>ğŸ“‹ Intrusion Event Log</h3>

  {% if intrusions %}
  <table>
    <tr>
      <th>Time</th>
      <th>Status</th>
      <th>Image Captured</th>
    </tr>

    {% for event in intrusions %}
    <tr>
      <!-- FIXED: Use tuple indices - event is (timestamp, motion, image_name) -->
      <td>{{ event[0] }}</td>
      <td><span class="badge-danger">ğŸ”´ Motion Detected</span></td>
      <td>
        {% if event[2] %}
          <!-- Note: event[2] is the image filename, not base64 data -->
          <span style="color: #3b82f6;">ğŸ“· {{ event[2] }}</span>
        {% else %}
          <span style="color: #6b7280;">No image</span>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </table>
  {% else %}
    <p style="color: #22c55e;">âœ… No intrusions recorded for {{ selected_date }}.</p>
  {% endif %}
</div>

{% endblock %}